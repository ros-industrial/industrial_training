# Motion Planning using RViz
> In this exercise, we will (finally) learn how to use the MoveIt! RViz plugin to plan and execute motion on a simulated robot. We will explore the different options and constraints associated with both MoveIt! and the RViz plugin.


## Launch the Planning Environment

 1. Source your ROS2 workspace.

 1. Bring up the planning environment, with simulated execution:

    ```
    ros2 launch myworkcell_moveit_config myworkcell_planning_execution.launch.py
    ```

## Plugin Display Options

 1. Find and test the following display options in the Displays panel, _Motion Planning_ display

    * _Scene Robot -> Show Robot Visual_

    * _Scene Robot -> Show Robot Collision_

    * _Planning Request -> Query Start State_

    * _Planning Request -> Query Goal State_

 1. For now, enable display of the _Show Robot Visual_ and _Query Goal State_, leaving _Show Robot Collision_ and _Query Start State_ disabled

 1. Use the Panels dropdown next to File to display a trajectory preview slider by checking the _Motion Planning - Trajectory Slider_ box
 
    * _this slider allows for detailed review of the last planned trajectory_
    * Check the _Context_ tab in the motion planning panel to ensure that _RRTConnect_ is selected.
    * If you are struggling to find a motion plan, try increasing the planning time and/or planning attempts.

## Basic Motion

 1. In the _Motion Planning_ panel, select the _Planning_ tab

 1. Under the _Query_ section, expand the _Select Goal State_ section

    * _select \<random valid\>_
    * you may need to repeat this a few times to get a position that is not in collision.  The robot model will be shaded RED if MoveIt detects a collision.  "Random Valid" is supposed to find a collision-free target position, but quits trying after 100 random-sampling attempts.
    * _observe the goal position in the graphics window_

 1. Click _Plan_ to see the robot motion generated by the MoveIt! planning libraries

    * _select Displays -> Motion Planning -> Planned Path -> Loop Animation to show the planned path in a cyclic display._
    * _select Displays -> Motion Planning -> Planned Path -> Show Trail to show the planned path in a swept display._

 1. Click _Execute_ to run the motion on the simulated robot

    * _observe that the multi-colored scene robot display updates to show that the robot has "moved" to the goal position_

 1. Repeat steps 2-5 a few more times

    * _try using the interactive marker to manually move the robot to a desired position_
    * _try using a named pose (e.g. "straight up")_

## Beyond the Basics

 1. Experiment with different Planning Algorithms

    * _select Context tab, choose a Planning Algorithm (drop-down box below "OMPL")_

    * _the RRTConnect algorithm is one of our favorites._

 1. Environment Obstacles

    * Adjust the Goal State to move the robot into collision with an obstacle (e.g. the table)

      * note the colliding links are colored red

      * depending on the "Collision-Aware IK" setting on the Planning tab, the robot may try to search through different IK solutions to find a non-colliding solution.

    * Try to plan a path through the obstacle

      * It may help to have "Collision-Aware IK" disabled when moving the Goal State

      * If the robot fails to plan, check the error log and try repeating the plan request

      * Because the default planners are sampling-based, they may produce different results on each execution

      * You can also try increasing the planning time to allow a successful plan to be created

      * Try different planning algorithms in this, more complex, planning task

    * Try adding a new obstacle to the scene:
      * Under the Scene Objects tab, Add a Box object (0.1 x 1.0 x 0.1)
      * Move the Box into an interesting position, using the manipulation handles
      * Press Publish Scene, to push the updated position to MoveIt
      * Try to plan around the obstacle
